<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Tenebris Ledger</title>
<meta name="theme-color" content="#0b0710">
<style>
/*
  ==============================================
  –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –û–°–ù–û–í–ù–û–ô –°–¢–ò–õ–¨
  ==============================================
  */
  :root{
    --bg:#08060a; /* –ë–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω */
    --card:#141216; /* –§–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ */
    --text:#f0f0f0; /* –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
    --muted:#a99bb3; /* –ü—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç */
    --accent:#d62828; /* –Ø—Ä–∫–∏–π –∫—Ä–∞—Å–Ω—ã–π (—Ä–∞—Å—Ö–æ–¥) */
    --accent-2:#8338ec; /* –Ø—Ä–∫–∏–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (–¥–æ—Ö–æ–¥/–≥–ª–∞–≤–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç) */
    --glass: rgba(255,255,255,0.04); /* –≠—Ñ—Ñ–µ–∫—Ç "—Å—Ç–µ–∫–ª–∞" */
    --radius:18px;
    --goal-color: #00b4d8; /* –¶–≤–µ—Ç –¥–ª—è —Ü–µ–ª–µ–π (–Ω–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç) */
  }
  *{box-sizing:border-box; transition: all 0.2s ease-out; }
  /* –î–∏–Ω–∞–º–∏—á–Ω—ã–π –∏ –ø—Ä–∏—è—Ç–Ω—ã–π —Ñ–æ–Ω */
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#040306 0%, #0c0910 100%);color:var(--text);font-family:'JetBrains Mono', 'Fira Code', monospace; font-size:14px; }
  h1{font-family:Georgia, serif;margin:0}
  
  /*
  ==============================================
  –û–ë–©–ò–ï –≠–õ–ï–ú–ï–ù–¢–´
  ==============================================
  */
  .app{padding:12px;max-width:1200px;margin:0 auto} /* –£–≤–µ–ª–∏—á–∏–ª max-width –¥–ª—è 3-—Ö –∫–æ–ª–æ–Ω–æ–∫ */
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .logo{display:flex;flex-direction:column}
  
  /* –ù–∞–≤–∏–≥–∞—Ü–∏—è (–®–ê–ü–ö–ê) */
  .tablist{display:flex; justify-content:space-around; background:var(--card); border-radius:12px; padding:6px; margin-bottom:16px; box-shadow:0 4px 15px rgba(0,0,0,0.4);}
  .tab{flex:1;text-align:center;padding:12px 0;font-weight:bold;color:var(--muted);cursor:pointer;border-radius:8px;}
  .tab.active{background:var(--accent-2);color:white;box-shadow:0 2px 10px rgba(131,56,236,0.6);}
  
  /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≤–∫–ª–∞–¥–∫–∏ */
  .tabs{display:none;}
  
  .balance-card{background:linear-gradient(145deg, var(--card), #100f12);border-radius:24px;padding:16px;margin-bottom:12px;box-shadow:0 12px 30px rgba(0,0,0,0.6); border:1px solid var(--glass)}
  .balance-line{display:flex;justify-content:space-between;align-items:center}
  .balance-title{font-size:16px;color:var(--muted)} .balance-value{font-size:32px;font-weight:800; color:#fff}
  
  /*
  ==============================================
  –§–û–†–ú–´ –ò –ö–ù–û–ü–ö–ò
  ==============================================
  */
  .quick-input{margin-top:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input.amount{flex:1;border-radius:12px;padding:12px 14px;border:1px solid rgba(255,255,255,0.08);font-size:20px;background:var(--card);color:inherit;min-width:100px;box-shadow:inset 0 1px 3px rgba(0,0,0,0.4)}
  /* –£–≤–µ–ª–∏—á–µ–Ω—ã —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
  select, input[type=text], input[type=number], input[type=date], .input-like{flex:1;min-width:100px;border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.08);background:var(--card);color:inherit;appearance:none; font-size:16px; }
  select:focus, input:focus, button:focus, .big-btn:focus { outline:1px solid var(--accent-2); box-shadow:0 0 5px rgba(131,56,236,0.6); }

  .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .card{background:var(--card);border-radius:16px;padding:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap; border:1px solid var(--glass); cursor:default;}
  .card.clickable:hover{box-shadow:0 4px 15px rgba(0,0,0,0.4); transform: translateY(-2px);}

  /* –£–≤–µ–ª–∏—á–µ–Ω—ã –∫–Ω–æ–ø–∫–∏ + / - */
  .big-btn{width:40px;height:40px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold; background:var(--card); color:var(--text); padding:0; font-size:18px; }
  .big-btn:hover{background:rgba(255,255,255,0.1); border-color:var(--accent-2); }
  
  .fab{position:fixed;right:18px;bottom:24px;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:white;width:55px;height:55px;border-radius:50%;border:0;cursor:pointer;font-size:30px;font-weight:bold;z-index:100; box-shadow:0 4px 15px rgba(0,0,0,0.8);}
  .fab:hover{transform:scale(1.05);}
  
  .hidden{display:none}
  button{cursor:pointer;font-weight:600;color:inherit; background:none; border:none; padding:10px 14px; border-radius:10px; font-size:16px;}
  button:hover{background:rgba(255,255,255,0.1);}
  
  .top-actions button{ width:40px; height:40px; border-radius:10px; padding:0; margin-left:8px; font-size:18px; border:1px solid var(--glass); }
  .top-actions button:hover{ background:rgba(255,255,255,0.1); }
  
  /*
  ==============================================
  –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
  ==============================================
  */
  .modal-overlay{ position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(5px); z-index:998; }
  .modal{ position:fixed; left:50%; transform:translateX(-50%); top:12%; background:var(--bg); padding:16px; border-radius:16px; border:1px solid rgba(255,255,255,0.08); box-shadow:0 12px 30px rgba(0,0,0,0.8); z-index:999; max-height:80vh; overflow-y:auto; max-width:550px; width:95%;}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px; padding-bottom:8px; border-bottom:1px solid var(--glass);}

  /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (—Å—Ç–µ–∫) */
  #rulesModal { top: 5%; }
  #settingsModal { top: 15%; }
  #debtModal { top: 25%; }
  #newDebtModal { top: 35%; }
  #goalsModal { top: 45%; }

  /*
  ==============================================
  –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –°–ï–¢–ö–ê (–ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ "–°—á–µ—Ç–∞" –∏–ª–∏ "–†–∞—Å—Ö–æ–¥—ã")
  ==============================================
  */
  @media(min-width:1024px){ /* –î–µ—Å–∫—Ç–æ–ø: 3 –∫–æ–ª–æ–Ω–∫–∏ */
    .grid{display:grid;grid-template-columns:300px 1fr 300px;gap:16px} 
    #rightCol { display: flex; flex-direction: column; } /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ */
  }
  @media(min-width:768px) and (max-width:1023px) { /* –ü–ª–∞–Ω—à–µ—Ç—ã: 2 –∫–æ–ª–æ–Ω–∫–∏ */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    /* –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ø—Ä–∞–≤—É—é –∫–æ–ª–æ–Ω–∫—É –≤–Ω–∏–∑ */
    #rightCol { grid-column: span 2; order: 3; } 
    #leftCol { order: 1; }
    #centerCol { order: 2; }
  }
  @media(max-width:1100px){
  .grid{
    display:flex;
    flex-direction:column;
  }

  #rightCol { order: 1; }   /* –û–ö–ù–û 3 ‚Äî –ü–ï–†–í–û–ï */
  #centerCol { order: 2; }  /* –û–ö–ù–û 2 ‚Äî –í–¢–û–†–û–ï */
  #leftCol { order: 3; }    /* –û–ö–ù–û 1 ‚Äî –ü–û–°–õ–ï–î–ù–ï–ï */
}

    .quick-input > * { min-width: 100%; } /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    .top-actions { display:flex; gap:0; }
  }
  
  /*
  ==============================================
  –°–¢–ò–õ–ò –î–û–õ–ì–û–í
  ==============================================
  */
  .debt-section{ margin-top:20px; }
  .debt-title{ font-size:18px; font-weight:bold; color:var(--text); padding:10px 0; border-bottom:1px solid var(--glass); margin-bottom:10px; }
  .debt-card{ background:var(--card); border-radius:12px; padding:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; border:1px solid var(--glass); cursor:pointer;}
  .debt-card:hover { box-shadow:0 4px 15px rgba(0,0,0,0.4); transform: translateY(-2px); }
  .debt-info{flex-grow:1;}
  .debt-name{font-size:16px; font-weight:bold;}
  .debt-meta{font-size:12px; color:var(--muted);}
  .debt-amount{font-size:22px; font-weight:800;}
  .debt-amount.owed{color:var(--accent-2);} /* –ú–Ω–µ –¥–æ–ª–∂–Ω—ã */
  .debt-amount.mine{color:var(--accent);} /* –Ø –¥–æ–ª–∂–µ–Ω */
  
  .debt-actions{ background:var(--card); border:none; padding:10px; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; margin-left:10px; font-weight:900; }
  .debt-actions:hover{ background:rgba(255,255,255,0.1); }

  #debtModal .modal-content { display:flex; flex-direction:column; gap:10px; }
  #debtModal button { width:100%; }
  
  /*
  ==============================================
  –°–¢–ò–õ–ò –ò–°–¢–û–†–ò–ò –î–û–õ–ì–û–í
  ==============================================
  */
  .history-item { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed var(--glass); font-size:12px; }
  .history-item:last-child { border-bottom:none; padding-bottom:0; }
  .history-item .h-date { color:var(--muted); }
  .history-item .h-name { font-weight:bold; }
  .history-item .h-amount.received { color:var(--accent-2); } /* –ó–∞–º–µ–Ω–µ–Ω–æ repaid –Ω–∞ received –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏ */
  .history-item .h-amount.repaid { color:var(--accent); } /* –ó–∞–º–µ–Ω–µ–Ω–æ paid –Ω–∞ repaid –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏ */


  /*
  ==============================================
  –°–¢–ò–õ–ò –û–ë–ó–û–†–ê
  ==============================================
  */
  .summary-block{ padding:16px; border-radius:18px; background:var(--card); border:1px solid var(--glass); margin-bottom:16px; }
  .summary-item{ display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px dashed var(--glass); }
  .summary-item:last-child{ border-bottom:none; padding-bottom:0; }
  .summary-item .label{ color:var(--muted); font-size:14px; }
  .summary-item .value{ font-weight:bold; font-size:18px; }
  .summary-item.total .value{ font-size:26px; color:var(--accent-2); }
  .summary-item.expense .value{ color:var(--accent); }
  .summary-item.income .value{ color:var(--accent-2); }
  
  .period-toggle{ display:flex; gap:0; background:rgba(255,255,255,0.05); border-radius:10px; padding:4px; }
  .period-toggle button{ padding:8px 12px; border-radius:8px; font-size:14px; border:none; background:transparent; }
  .period-toggle button.active{ background:var(--accent-2); color:#fff; font-weight:bold; box-shadow:0 1px 5px rgba(0,0,0,0.5); }

  /*
  ==============================================
  –°–¢–ò–õ–ò –§–ò–ù–ê–ù–°–û–í–´–• –¶–ï–õ–ï–ô (–ù–û–í–ê–Ø –û–ü–¶–ò–Ø)
  ==============================================
  */
  .goal-card { background:linear-gradient(145deg, var(--card), #18151c); border-radius:12px; padding:12px; margin-bottom:10px; border:1px solid var(--glass); cursor:pointer;}
  .goal-card:hover { border-color:var(--goal-color); transform: translateY(-2px); }
  .goal-title { font-weight:bold; font-size:16px; color:var(--goal-color); }
  .goal-progress { height:8px; background:rgba(255,255,255,0.1); border-radius:4px; overflow:hidden; margin:8px 0; }
  .goal-progress-bar { height:100%; background:var(--goal-color); width:0%; transition:width 0.5s ease-out; }
  .goal-meta { display:flex; justify-content:space-between; font-size:12px; color:var(--muted); }
  
  /*
  ==============================================
  –°–¢–ò–õ–ò –í–∫–ª–∞–¥–∫–∏ "–†–∞—Å—Ö–æ–¥—ã" (–ù–û–í–´–ô –ê–ù–ê–õ–ò–ó)
  ==============================================
  */
  .expense-summary-grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:20px; }
  .expense-table-container { grid-column: 1 / span 2; max-height: 400px; overflow-y: auto; }
  .category-table { width:100%; border-collapse: collapse; margin-top:10px; }
  .category-table th, .category-table td { padding:10px; text-align:left; border-bottom:1px solid var(--glass); }
  .category-table th { color:var(--muted); font-weight:normal; font-size:12px; }
  .category-table td .category-name { font-weight:bold; }
  .category-table td .category-amount { color:var(--accent); font-weight:bold; }
  .category-table tr:hover { background:rgba(255,255,255,0.05); }
  .chart-container { max-width: 100%; height: 250px; position:relative; } /* –î–ª—è —Ö–æ–ª—Å—Ç–∞ Chart.js */

/* ===== Mobile fix: Expenses analysis ===== */
@media (max-width: 768px) {

  /* —É–±–∏—Ä–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
  body {
    overflow-x: hidden;
  }

  /* –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∞–Ω–∞–ª–∏–∑–æ–≤ ‚Äî –≤ –∫–æ–ª–æ–Ω–∫—É */
  .expenses-grid,
  .analysis-row,
  .analysis-grid {
    display: flex !important;
    flex-direction: column !important;
  }

  /* –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ —à–∏—Ä–µ —ç–∫—Ä–∞–Ω–∞ */
  .card,
  .analysis-card {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box;
  }

  /* canvas / –¥–∏–∞–≥—Ä–∞–º–º—ã */
  canvas {
    max-width: 100% !important;
    height: auto !important;
  }

  /* —Ç–∞–±–ª–∏—Ü—ã */
  table {
    width: 100% !important;
    display: block;
    overflow-x: auto;
  }
}

#leftCol,
#centerCol,
#rightCol {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* === –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã === */

.signals {
  border: 1px solid rgba(255,255,255,0.06);
  background: linear-gradient(160deg, #141216, #100e14);
}

.signals-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}

.signals-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

/* –°—Ç–∞—Ç—É—Å */
.signals-status {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.3px;
}

.signals-status.ok {
  background: rgba(131,56,236,0.15);
  color: var(--accent-2);
}

.signals-status.warn {
  background: rgba(255,190,11,0.15);
  color: #ffbe0b;
}

.signals-status.bad {
  background: rgba(214,40,40,0.15);
  color: var(--accent);
}

/* –°–µ—Ç–∫–∞ */
.signals-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px 16px;
}

.signal {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.signal-label {
  font-size: 12px;
  color: var(--muted);
}

.signal-value {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
}

.signal-value.big {
  font-size: 22px;
}

.signal-value.expense {
  color: var(--accent);
}

.signal-value.muted {
  color: var(--muted);
}

/* –ú–æ–±–∏–ª–∫–∞ */
@media (max-width: 480px) {
  .signals-grid {
    grid-template-columns: 1fr;
  }
}

/* === –û–±–∑–æ—Ä + –°–∏–≥–Ω–∞–ª—ã: 50 / 50 === */
.overview-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  align-items: stretch;
}

/* —á—Ç–æ–±—ã –±–ª–æ–∫–∏ –Ω–µ —Å—Ö–ª–æ–ø—ã–≤–∞–ª–∏—Å—å */
.overview-row .summary-block {
  height: 100%;
}

/* –∞–¥–∞–ø—Ç–∏–≤ */
@media (max-width: 900px) {
  .overview-row {
    grid-template-columns: 1fr;
  }
}

/* === –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä–∏ –∑—É–º–µ –∏ —É–∑–∫–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö === */
@media (max-width: 1100px) {
  .overview-row {
    grid-template-columns: 1fr;
  }
}

.summary-block {
  min-width: 0;
}

/* === –ö–û–õ–û–ù–ù–ê –ü–†–ò –ó–£–ú–ï / –£–ó–ö–û–ú –û–ö–ù–ï ‚Äî –§–ò–ù–ê–õ === */
@media (max-width: 1100px) {
  .grid {
    display: flex;
    flex-direction: column;
  }

  /* –û–ë–†–ê–¢–ù–´–ô –ü–û–†–Ø–î–û–ö –û–ö–û–ù */
  #rightCol  { order: 1; }
  #centerCol { order: 2; }
  #leftCol   { order: 3; }
}


  #rightCol {
    order: 1;
  }

  #centerCol {
    order: 2;
  }

  #leftCol {
    order: 3;
  }
}

</style>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
</head>
<body>
  
    <div id="rulesModal" class="hidden modal">
    <div class="modal-header">
      <div class="small" style="color:var(--text); font-weight:bold; font-size:18px;">–ê–≤—Ç–æ–ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è / –ê–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è</div>
      <button id="closeRules">‚úï</button>
    </div>
    
    <div id="newRuleForm" style="border:1px solid var(--accent-2); border-radius:12px; padding:12px; margin-bottom:16px; display:none;">
      <h4 style="margin:0 0 10px 0; color:var(--accent-2)">–ù–æ–≤–æ–µ –ü—Ä–∞–≤–∏–ª–æ</h4>
      <input id="ruleName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Netflix)" style="width:100%; margin-bottom:8px;" />
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input id="ruleAmount" type="number" placeholder="–°—É–º–º–∞" style="flex:1" />
        <select id="ruleType" style="flex:1"><option value="expense">–°–ø–∏—Å–∞–Ω–∏–µ</option><option value="income">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</option></select>
      </div>
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input id="ruleNextDate" type="date" style="flex:1" />
        <select id="ruleFrequency" style="flex:1">
          <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
          <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
          <option value="yearly">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="saveRuleBtn" style="flex:1; background:var(--accent-2); color:#fff; padding:10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ü—Ä–∞–≤–∏–ª–æ</button>
        <button id="cancelRuleBtn" style="background:var(--card);">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    
    <div id="rulesList" style="margin-top:10px"></div>
    <div style="margin-top:16px"><button id="newRuleBtn" style="width:100%; border:1px solid var(--accent-2); background:rgba(131,56,236,0.2)">+ –ù–æ–≤–æ–µ –ü—Ä–∞–≤–∏–ª–æ (–ü–æ–¥–ø–∏—Å–∫–∞/–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂)</button></div>
  </div>
  
  <div id="settingsModal" class="hidden modal">
    <div class="modal-header">
      <div class="small" style="color:var(--text); font-weight:bold; font-size:18px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –†–µ–¥–∞–∫—Ç–æ—Ä</div>
      <button id="closeSettings">‚úï</button>
    </div>
    
    <h3 style="margin:16px 0 8px 0; color:var(--accent-2)">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
    <div id="categoryList" class="list"></div>
    <div style="margin-top:12px"><button id="newCatBtn" style="width:100%; border:1px solid var(--glass)">+ –ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</button></div>

    <h3 style="margin:16px 0 8px 0; color:var(--accent-2)">–°—á–µ—Ç–∞</h3>
    <div id="accountSettingsList" class="list"></div>
    <div style="margin-top:12px"><button id="newAccBtn" style="width:100%; border:1px solid var(--glass)">+ –ù–æ–≤—ã–π —Å—á–µ—Ç</button></div>

    <h3 style="margin:16px 0 8px 0; color:var(--accent-2)">–ë—é–¥–∂–µ—Ç—ã</h3>
    <div id="budgetSettingsList" class="list"></div>
    <div style="margin-top:12px"><button id="newBudgetBtn" style="width:100%; border:1px solid var(--glass)">+ –ù–æ–≤—ã–π –±—é–¥–∂–µ—Ç</button></div>
  </div>
  
  <div id="debtModal" class="hidden modal">
    <div class="modal-header">
      <div class="small" style="color:var(--text); font-weight:bold; font-size:18px;">–î–µ–π—Å—Ç–≤–∏–µ —Å –¥–æ–ª–≥–æ–º</div>
      <button id="closeDebtModal">‚úï</button>
    </div>
    <div id="debtModalContent" class="modal-content">
      <input id="debtActionAmount" type="number" placeholder="–°—É–º–º–∞" />
      <input id="debtActionName" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
      <select id="debtActionAccount" title="–°—á–µ—Ç –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–∏"></select>
      <div id="owedActions" style="display:none; flex-direction:column; gap:10px;">
        <button id="debtReceiveBtn" style="background:var(--accent-2); color:#fff">–ü–æ–ª—É—á–∏—Ç—å (–ü–æ–≥–∞—Å–∏—Ç—å) –î–æ–ª–≥</button>
        <button id="debtForgiveBtn" style="background:var(--accent); color:#fff">–ü—Ä–æ—Å—Ç–∏—Ç—å –î–æ–ª–≥</button>
      </div>
      <div id="mineActions" style="display:none; flex-direction:column; gap:10px;">
        <button id="debtRepayBtn" style="background:var(--accent-2); color:#fff">–ü–æ–≥–∞—Å–∏—Ç—å (–°–≤–æ–π) –î–æ–ª–≥</button>
        <button id="debtAskForgiveBtn" style="background:var(--accent); color:#fff">–£–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –¥–æ–ª–≥ (–ü—Ä–æ—â–µ–Ω–∏–µ)</button>
      </div>
    </div>
  </div>

    <div id="newDebtModal" class="hidden modal">
    <div class="modal-header">
      <div class="small" style="color:var(--text); font-weight:bold; font-size:18px;" id="newDebtTitle">–ù–æ–≤—ã–π –î–æ–ª–≥</div>
      <button id="closeNewDebtModal">‚úï</button>
    </div>
    <div id="newDebtModalContent" class="modal-content">
      <input id="newDebtAmount" type="number" placeholder="–°—É–º–º–∞ –¥–æ–ª–≥–∞" />
      <input id="newDebtName" type="text" placeholder="–ò–º—è/–û–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–≥–∞" />
      <button id="saveNewDebtBtn" style="background:var(--accent-2); color:#fff">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>

  <div id="goalsModal" class="hidden modal">
    <div class="modal-header">
      <div class="small" style="color:var(--text); font-weight:bold; font-size:18px;" id="goalsModalTitle">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¶–µ–ª–∏</div>
      <button id="closeGoalsModal">‚úï</button>
    </div>
    
    <div id="newGoalForm" style="border:1px solid var(--goal-color); border-radius:12px; padding:12px; margin-bottom:16px; display:none;">
      <h4 style="margin:0 0 10px 0; color:var(--goal-color)">–ù–æ–≤–∞—è –¶–µ–ª—å</h4>
      <input id="goalName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–∞–∫–±—É–∫)" style="width:100%; margin-bottom:8px;" />
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input id="goalTarget" type="number" placeholder="–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞" style="flex:1" />
        <input id="goalCurrent" type="number" placeholder="–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞ (0)" style="flex:1" value="0" />
      </div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="saveGoalBtn" style="flex:1; background:var(--goal-color); color:#fff; padding:10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¶–µ–ª—å</button>
        <button id="cancelGoalBtn" style="background:var(--card);">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
    
    <div id="goalsSettingsList" style="margin-top:10px"></div>
    <div style="margin-top:16px"><button id="newGoalBtn" style="width:100%; border:1px solid var(--goal-color); color:var(--goal-color);">+ –ù–æ–≤–∞—è –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –¶–µ–ª—å</button></div>
  </div>

  <div id="modalOverlay" class="hidden modal-overlay"></div>

    <div class="app">
    <div class="header">
      <div class="logo"><h1>Tenebris</h1><div class="small">ledger</div></div>
      <div class="top-actions">
        <button id="rulesBtn" title="–ü–æ–¥–ø–∏—Å–∫–∏/–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏">‚ü≥</button>
        <button id="settingsBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>
      </div>
    </div>

        <div class="tablist">
      <div class="tab" data-tab="debts" id="tabDebts">–î–æ–ª–≥–∏</div>
      <div class="tab active" data-tab="accounts" id="tabAccounts">–°—á–µ—Ç–∞</div>
      <div class="tab" data-tab="expenses" id="tabExpenses">–†–∞—Å—Ö–æ–¥—ã</div>
    </div>
            <div id="debtsView" class="hidden">
      <div class="balance-card">
        <div class="balance-line">
          <div>
            <div class="balance-title">–û–±—â–∞—è —Å—É–º–º–∞ –¥–æ–ª–≥–æ–≤</div>
            <div class="balance-value" style="font-size:30px;"><span id="totalOwed">0,00‚ÇΩ</span> / <span id="totalMine">0,00‚ÇΩ</span></div>
          </div>
        </div>
      </div>
      
      <div class="debt-section">
        <div class="debt-title" style="border-bottom-color:var(--accent-2)">–ú–Ω–µ –¥–æ–ª–∂–Ω—ã</div>
        <div id="owedDebtsList">
          <div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –¥–æ–ª–∂–Ω—ã.</div>
        </div>
        <div style="margin-top:12px;"><button id="newOwedDebtBtn" data-type="owed" style="width:100%; border:1px solid var(--accent-2); color:var(--accent-2);">+ –ù–æ–≤—ã–π –¥–æ–ª–≥ (–ú–Ω–µ –¥–æ–ª–∂–Ω—ã)</button></div>
      </div>
      
      <div class="debt-section">
        <div class="debt-title" style="border-bottom-color:var(--accent)">–Ø –¥–æ–ª–∂–µ–Ω</div>
        <div id="mineDebtsList">
          <div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –¥–æ–ª–∂–Ω—ã.</div>
        </div>
        <div style="margin-top:12px;"><button id="newMineDebtBtn" data-type="mine" style="width:100%; border:1px solid var(--accent); color:var(--accent);">+ –ù–æ–≤—ã–π –¥–æ–ª–≥ (–Ø –¥–æ–ª–∂–µ–Ω)</button></div>
      </div>
      
      <div class="debt-section">
        <div class="debt-title" style="border-bottom-color:var(--glass)">–ò—Å—Ç–æ—Ä–∏—è –ü–æ–≥–∞—à–µ–Ω–∏–π</div>
        <div id="debtHistoryList">
          <div class="small" style="color:var(--muted)">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –¥–æ–ª–≥–∞–º–∏, –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å.</div>
        </div>
      </div>
    </div>
            <div id="accountsView">
      <div class="grid">
        
        <div class="left-col" id="leftCol">
          <div class="balance-card">
            <div class="balance-line" style="margin-bottom:10px">
              <div>
                <div class="balance-title">–¢–µ–∫—É—â–∏–π –ë–∞–ª–∞–Ω—Å</div>
                <div class="balance-value" id="currentBalance">0,00‚ÇΩ</div>
              </div>
              <div style="text-align:right">
                <div class="small">–ü—Ä–æ–≥–Ω–æ–∑ –¥–æ <span id="forecastDate">0000-00-00</span></div>
                <div class="balance-value" style="font-size:22px; color:var(--muted)" id="forecastBig">0,00‚ÇΩ</div>
              </div>
            </div>
            
            <div style="display:flex; justify-content:space-between; gap:4px; margin-bottom:4px;">
              <div class="month-bar" style="flex:1; height:4px; background:var(--bg); border-radius:2px; overflow:hidden;">
                <div id="monthBarExpense" class="month-left" style="background:var(--accent); height:100%; width:50%; float:left;"></div>
              </div>
              <div class="month-bar" style="flex:1; height:4px; background:var(--bg); border-radius:2px; overflow:hidden;">
                <div id="monthBarIncome" class="month-right" style="background:var(--accent-2); height:100%; width:50%; float:right;"></div>
              </div>
            </div>
            <div class="month-bar-info" style="display:flex; justify-content:space-between;">
              <div class="small" style="color:var(--accent)">‚àí <span id="monthExpense">0,00‚ÇΩ</span></div>
              <div class="small" style="color:var(--accent-2)">+ <span id="monthIncome">0,00‚ÇΩ</span></div>
            </div>

            <h3 style="margin:16px 0 8px 0; font-size:18px; color:var(--muted)">–°—á–µ—Ç–∞</h3>
            <div class="list" id="accountsList">
              <div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—á–µ—Ç–æ–≤.</div>
            </div>
          </div>

        
        </div>

        <div id="centerCol">
          <div class="balance-card">
            <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
              <div><div class="small" id="monthLabel">–Ø–Ω–≤–∞—Ä—å</div><div style="font-size:20px; font-weight:bold; color:var(--accent-2)">+ <span id="topIncome">0,00‚ÇΩ</span></div></div>
              <div style="font-size:20px; font-weight:bold; color:var(--accent)">‚àí <span id="topExpense">0,00‚ÇΩ</span></div>
            </div>

            <div class="quick-input">
              <input id="qAmount" class="amount" type="number" placeholder="–°—É–º–º–∞" />
              <input id="qNote" type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" />
              <select id="qCat"></select>
              <select id="qAccount"></select>
            </div>
            
            <div style="display:flex;gap:8px;margin-top:12px;align-items:center;justify-content:space-between;width:100%">
              <div class="small" id="quickStats">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: <span id="txnCount">0</span></div>
              <div style="display:flex;gap:8px">
                <button id="qAdd" style="background:var(--accent-2); color:#fff;">–î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>

          <div id="rightCol">
            <div class="summary-block" style="border-color:var(--goal-color)">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <div style="font-size:18px; font-weight:bold; color:var(--goal-color)">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¶–µ–ª–∏</div>
              <button id="openGoalsBtn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–∏" style="border:1px solid var(--goal-color); color:var(--goal-color); padding:5px 10px; font-size:12px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            </div>
            <div id="goalsList">
              <div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π.</div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
        
        <div id="expensesView" class="hidden">
            <div class="balance-card">
              <div class="overview-row">

              <div class="summary-block">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <div style="font-size:18px; font-weight:bold; color:var(--text)">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –û–±–∑–æ—Ä</div>
        <div class="period-toggle" id="summaryPeriodToggle">
          <button data-period="month" class="active">–ú–µ—Å—è—Ü</button>
          <button data-period="week">–ù–µ–¥–µ–ª—è</button>
        </div>
      </div>

      <div class="summary-item total">
        <div class="label">–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –Ω–∞—á–∞–ª–æ <span id="summaryPeriodName">–º–µ—Å—è—Ü–∞</span></div>
        <div class="value" id="startBalance">0,00‚ÇΩ</div>
      </div>

      <div class="summary-item income">
        <div class="label">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è (<span id="summaryIncomeLabel">–∑–∞ –º–µ—Å—è—Ü</span>)</div>
        <div class="value" id="summaryIncome">+0,00‚ÇΩ</div>
      </div>

      <div class="summary-item expense">
        <div class="label">–†–∞—Å—Ö–æ–¥—ã (<span id="summaryExpenseLabel">–∑–∞ –º–µ—Å—è—Ü</span>)</div>
        <div class="value" id="summaryExpense">‚àí0,00‚ÇΩ</div>
      </div>

      <div class="summary-item">
        <div class="label">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (–ê–≤—Ç–æ-) —Ç—Ä–∞—Ç—ã</div>
        <div class="value" id="summaryRulesExpense" style="color:var(--accent)">‚àí0,00‚ÇΩ</div>
      </div>

      <div class="summary-item">
        <div class="label">–û–∂–∏–¥–∞–µ–º—ã–π —á–∏—Å—Ç—ã–π –æ—Å—Ç–∞—Ç–æ–∫</div>
        <div class="value" id="summaryNetBalance" style="font-size:22px;">0,00‚ÇΩ</div>
      </div>
    </div>

    <!-- –ü–†–ê–í–û: –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã -->
    <div class="summary-block signals">
      <div class="signals-header">
        <div class="signals-title">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã</div>
        <div class="signals-status ok" id="financeStatus">–ù–æ—Ä–º–∞</div>
      </div>

      <div class="signals-grid">
        <div class="signal">
          <div class="signal-label">–°–∞–º–∞—è –∑–∞—Ç—Ä–∞—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</div>
          <div class="signal-value" id="topCategory">‚Äî</div>
        </div>

        <div class="signal">
          <div class="signal-label">–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ / –¥–µ–Ω—å</div>
          <div class="signal-value expense" id="avgDailyExpense">‚Äî</div>
        </div>

        <div class="signal">
          <div class="signal-label">–î–µ–Ω–µ–≥ —Ö–≤–∞—Ç–∏—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ</div>
          <div class="signal-value big" id="daysLeft">‚Äî –¥–Ω–µ–π</div>
        </div>

        <div class="signal">
          <div class="signal-label">–ë–ª–∏–∂–∞–π—à–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ</div>
          <div class="signal-value muted" id="nextRule">‚Äî</div>
        </div>
      </div>
    </div>

  </div>

                <div class="balance-title" style="margin-bottom:10px;">–ê–Ω–∞–ª–∏–∑ –†–∞—Å—Ö–æ–¥–æ–≤ (–¢–µ–∫—É—â–∏–π –ú–µ—Å—è—Ü)</div>
                <div class="expense-summary-grid">
                    <div class="summary-block" style="margin-bottom:0;">
                        <div class="small" style="margin-bottom:8px; color:var(--muted);">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–î–∏–∞–≥—Ä–∞–º–º–∞)</div>
                        <div class="chart-container"><canvas id="expenseDoughnutChart"></canvas></div>
                    </div>
                    <div class="summary-block" style="margin-bottom:0;">
                        <div class="small" style="margin-bottom:8px; color:var(--muted);">–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ 6 –º–µ—Å—è—Ü–µ–≤</div>
                        <div class="chart-container"><canvas id="expenseLineChart"></canvas></div>
                    </div>
                    <div class="expense-table-container">
                        <div class="debt-title" style="border-bottom-color:var(--accent); font-size:16px;">–î–µ—Ç–∞–ª—å–Ω—ã–π –ê–Ω–∞–ª–∏–∑ (–¢–µ–∫—É—â–∏–π –ú–µ—Å—è—Ü)</div>
                        <table class="category-table">
                            <thead>
                                <tr><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</th><th>–°—É–º–º–∞</th><th>%</th></tr>
                            </thead>
                            <tbody id="categoryTableBody">
                                <tr><td colspan="4" class="small" style="color:var(--muted); text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
    </div>
  </div>

<script>
(() => {
  /* ==============================================
    –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
    ============================================== */
  const uid = () => Math.random().toString(36).slice(2,9);
  const today = () => new Date().toISOString().slice(0,10);
  const formatCurrency = (amount) => (Number(amount) || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ") + '‚ÇΩ';
  const isToday = (dateStr) => dateStr === today();
  
  function getEndOfMonth(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return new Date(d.getFullYear(), d.getMonth() + 1, 0).toISOString().slice(0,10);
  }
  
  function getStartOfMonth(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return new Date(d.getFullYear(), d.getMonth(), 1).toISOString().slice(0,10);
  }
  
  function getMonthName(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleString('ru-RU', { month: 'long' });
  }
  
  function getStartOfWeek(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const dayOfWeek = d.getDay();
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∫–∞–∫ –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ (1, –∞ –Ω–µ 0)
    const diff = d.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
    const startOfWeek = new Date(d.setDate(diff));
    return startOfWeek.toISOString().slice(0,10);
  }
  
  function getEndOfWeek(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const dayOfWeek = d.getDay();
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –∫–∞–∫ –∫–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏ (7-dayOfWeek)
    const diff = d.getDate() + (dayOfWeek === 0 ? 0 : 7 - dayOfWeek);
    const endOfWeek = new Date(d.setDate(diff));
    return endOfWeek.toISOString().slice(0,10);
  }
  
  function getMonthKey(dateStr) {
    if (!dateStr) return new Date().toISOString().slice(0, 7);
    try {
      const d = new Date(dateStr + 'T00:00:00');
      if (isNaN(d.getTime())) return new Date().toISOString().slice(0, 7);
      return d.toISOString().slice(0, 7);
    } catch (e) {
      return new Date().toISOString().slice(0, 7);
    }
  }
  
  const getColor = (() => {
    const colors = {};
    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏ —É–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞
    const palette = ['#8338ec', '#d62828', '#00b4d8', '#ffbe0b', '#fb5607', '#ff006e', '#3a86ff', '#8ac926', '#1a759f', '#ffc300', '#f94144', '#f8961e', '#43aa8b', '#277da1'];
    let index = 0;
    return (name) => {
      if (!colors[name]) {
        colors[name] = palette[index % palette.length];
        index++;
      }
      return colors[name];
    };
  })();
  
  /* ==============================================
    –•–†–ê–ù–ò–õ–ò–©–ï –î–ê–ù–ù–´–• (DB Class)
    ============================================== */
  class DB {
    async open(){ 
      if(!('indexedDB' in window)) return null;
      return new Promise((res)=>{ 
        const r=indexedDB.open('tenebris-db',1); 
        r.onupgradeneeded=e=>{const db=e.target.result; if(!db.objectStoreNames.contains('single')) db.createObjectStore('single',{keyPath:'id'})}; 
        r.onsuccess=e=>res(e.target.result); 
        r.onerror=()=>res(null); 
      });
    }
    async load(){ 
      try{ 
        const db=await this.open(); 
        if(!db){ const raw=localStorage.getItem('tenebris'); return raw?JSON.parse(raw):null; } 
        return new Promise(res=>{ 
          const tx=db.transaction('single','readonly'); const s=tx.objectStore('single'); const r=s.get('single'); 
          r.onsuccess=()=>res(r.result? r.result.payload:null); 
          r.onerror=()=>res(null); 
        }); 
      }catch(e){ const raw=localStorage.getItem('tenebris'); return raw?JSON.parse(raw):null; } 
    }
    async save(payload){ 
      try{ 
        const db=await this.open(); 
        if(!db){ localStorage.setItem('tenebris', JSON.stringify(payload)); return true; } 
        return new Promise(res=>{ 
          const tx=db.transaction('single','readwrite'); const s=tx.objectStore('single'); const r=s.put({id:'single',payload}); 
          r.onsuccess=()=>res(true); 
          r.onerror=()=>res(false); 
        }); 
      }catch(e){ localStorage.setItem('tenebris', JSON.stringify(payload)); return true; } 
    }
  }
  const db = new DB();
  
  /* ==============================================
    –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï (STATE)
    ============================================== */
  let state = {
    activeTab: 'accounts',
    accounts: [],
    transactions: [],
    categories: [],
    debts: [],
    budgets: [],
    rules: [],
    goals: [],
    currentPeriod: 'month',
    currentDate: today(),
    activeDebt: null, // –î–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ–π—Å—Ç–≤–∏–π —Å –¥–æ–ª–≥–æ–º
  };
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const defaultState = {
    accounts: [{id: uid(), name: '–ù–∞–ª–∏—á–Ω—ã–µ', balance: 0, initial: 0}],
    categories: [
      { id: uid(), name: '–ï–¥–∞', type: 'expense', icon: 'üçî' },
      { id: uid(), name: '–ó–∞—Ä–ø–ª–∞—Ç–∞', type: 'income', icon: 'üí∞' },
      { id: uid(), name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', type: 'expense', icon: 'üöó' },
      { id: uid(), name: '–ü–æ–¥–∞—Ä–∫–∏', type: 'income', icon: 'üéÅ' }
    ],
    transactions: [],
    debts: [], budgets: [], rules: [], goals: [],
    activeTab: 'accounts', currentPeriod: 'month', currentDate: today(), activeDebt: null,
  };
  
  /* ==============================================
    –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø UI/VIEW
    ============================================== */
  
  // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  function toggleModal(modalId, show) {
    const modal = document.getElementById(modalId);
    const overlay = document.getElementById('modalOverlay');
    if (modal && overlay) {
      if (show) {
        modal.classList.remove('hidden');
        overlay.classList.remove('hidden');
      } else {
        modal.classList.add('hidden');
        overlay.classList.add('hidden');
      }
    }
  }
  
  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
  function changeTab(tabName) {
    state.activeTab = tabName;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
  
    document.getElementById('debtsView').classList.add('hidden');
    document.getElementById('accountsView').classList.add('hidden');
    document.getElementById('expensesView').classList.add('hidden');
  
    document.getElementById(tabName + 'View').classList.remove('hidden');
  
    if (tabName === 'accounts') updateAccountsView();
    if (tabName === 'debts') updateDebtsView();
    if (tabName === 'expenses') updateExpensesView();
    saveState();
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—å—é "–°—á–µ—Ç–∞"
  function updateAccountsView() {
    // 1. –û–±—â–∏–π –±–∞–ª–∞–Ω—Å
    const totalBalance = state.accounts.reduce((sum, acc) => sum + acc.balance, 0);
    document.getElementById('currentBalance').textContent = formatCurrency(totalBalance);
  
    // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—á–µ—Ç–æ–≤
    const accountsList = document.getElementById('accountsList');
    accountsList.innerHTML = state.accounts.length === 0 ? '<div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—á–µ—Ç–æ–≤.</div>' : '';
    state.accounts.forEach(acc => {
      const div = document.createElement('div');
      div.className = 'card clickable';
      div.setAttribute('data-id', acc.id);
      div.innerHTML = `
        <div style="font-weight:bold">${acc.name}</div>
        <div style="font-size:18px; font-weight:bold; color:${acc.balance >= 0 ? 'var(--accent-2)' : 'var(--accent)'}">${formatCurrency(acc.balance)}</div>
      `;
      accountsList.appendChild(div);
    });
  
    // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –±—ã—Å—Ç—Ä–æ–≥–æ –≤–≤–æ–¥–∞
    updateQuickInput();
  
    // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–∑–æ—Ä–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    updateSummary();
    updateBudgetList();
    updateGoalsList();
    updateTxnList();
    updateMiniChart();
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –±—ã—Å—Ç—Ä–æ–≥–æ –≤–≤–æ–¥–∞
  function updateQuickInput() {
    const qCat = document.getElementById('qCat');
    const qAccount = document.getElementById('qAccount');
    qCat.innerHTML = '';
    qAccount.innerHTML = '';
  
    state.categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.id;
      option.textContent = `${cat.icon || ''} ${cat.name} (${cat.type === 'expense' ? '‚àí' : '+'})`;
      qCat.appendChild(option);
    });
  
    state.accounts.forEach(acc => {
      const option = document.createElement('option');
      option.value = acc.id;
      option.textContent = acc.name;
      qAccount.appendChild(option);
    });
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–∑–æ—Ä–∞ (–ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞)
  function updateSummary() {
    const now = new Date(state.currentDate);
    let startDate, endDate, periodName;

    if (state.currentPeriod === 'month') {
      startDate = getStartOfMonth(state.currentDate);
      endDate = getEndOfMonth(state.currentDate);
      periodName = '–º–µ—Å—è—Ü–∞';
    } else {
      startDate = getStartOfWeek(state.currentDate);
      endDate = getEndOfWeek(state.currentDate);
      periodName = '–Ω–µ–¥–µ–ª–∏';
    }

    const prevDate = new Date(startDate);
    prevDate.setDate(prevDate.getDate() - 1);
    const startBalance = calculateBalance(prevDate.toISOString().slice(0, 10));

    const periodTxns = state.transactions.filter(txn => txn.date >= startDate && txn.date <= endDate);
    const periodIncome = periodTxns.filter(txn => txn.amount > 0).reduce((sum, txn) => sum + txn.amount, 0);
    const periodExpense = periodTxns.filter(txn => txn.amount < 0).reduce((sum, txn) => sum + txn.amount, 0);

    const periodRulesExpense = state.rules.filter(rule => rule.type === 'expense').reduce((sum, rule) => {
      return sum + (rule.nextDate && rule.nextDate <= endDate ? Number(rule.amount) : 0);
    }, 0) * -1;

    const netBalance = startBalance + periodIncome + periodExpense + periodRulesExpense;

    const summaryPeriodNameEl = document.getElementById('summaryPeriodName');
    const summaryIncomeLabelEl = document.getElementById('summaryIncomeLabel');
    const summaryExpenseLabelEl = document.getElementById('summaryExpenseLabel');
    
    if (summaryPeriodNameEl) summaryPeriodNameEl.textContent = periodName;
    if (summaryIncomeLabelEl) summaryIncomeLabelEl.textContent = `–∑–∞ ${periodName.replace(/–∞$/, '')}`;
    if (summaryExpenseLabelEl) summaryExpenseLabelEl.textContent = `–∑–∞ ${periodName.replace(/–∞$/, '')}`;

    const startBalEl = document.getElementById('startBalance');
    const summaryIncomeEl = document.getElementById('summaryIncome');
    const summaryExpenseEl = document.getElementById('summaryExpense');
    const summaryRulesExpenseEl = document.getElementById('summaryRulesExpense');
    const summaryNetBalanceEl = document.getElementById('summaryNetBalance');
    
    if (startBalEl) startBalEl.textContent = formatCurrency(startBalance);
    if (summaryIncomeEl) summaryIncomeEl.textContent = formatCurrency(periodIncome);
    if (summaryExpenseEl) summaryExpenseEl.textContent = formatCurrency(periodExpense);
    if (summaryRulesExpenseEl) summaryRulesExpenseEl.textContent = formatCurrency(periodRulesExpense);
    if (summaryNetBalanceEl) summaryNetBalanceEl.textContent = formatCurrency(netBalance);

    // –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫ –≤ centerCol
    const monthLabelEl = document.getElementById('monthLabel');
    const topIncomeEl = document.getElementById('topIncome');
    const topExpenseEl = document.getElementById('topExpense');
    const txnCountEl = document.getElementById('txnCount');
    
    if (monthLabelEl) monthLabelEl.textContent = getMonthName(state.currentDate);
    if (topIncomeEl) topIncomeEl.textContent = formatCurrency(periodIncome);
    if (topExpenseEl) topExpenseEl.textContent = formatCurrency(periodExpense);
    if (txnCountEl) txnCountEl.textContent = periodTxns.length;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —à–∫–∞–ª—ã —Ä–∞—Å—Ö–æ–¥–æ–≤/–¥–æ—Ö–æ–¥–æ–≤
    const absIncome = Math.abs(periodIncome);
    const absExpense = Math.abs(periodExpense);
    const totalFlow = absIncome + absExpense;
    const incomePercent = totalFlow > 0 ? (absIncome / totalFlow) * 100 : 50;
    const expensePercent = totalFlow > 0 ? (absExpense / totalFlow) * 100 : 50;

    const monthBarExpenseEl = document.getElementById('monthBarExpense');
    const monthBarIncomeEl = document.getElementById('monthBarIncome');
    const monthIncomeEl = document.getElementById('monthIncome');
    const monthExpenseEl = document.getElementById('monthExpense');
    
    if (monthBarExpenseEl) monthBarExpenseEl.style.width = `${expensePercent}%`;
    if (monthBarIncomeEl) monthBarIncomeEl.style.width = `${incomePercent}%`;
    if (monthIncomeEl) monthIncomeEl.textContent = formatCurrency(absIncome);
    if (monthExpenseEl) monthExpenseEl.textContent = formatCurrency(absExpense);

    // –ü—Ä–æ–≥–Ω–æ–∑ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
    const totalBalanceNow = state.accounts.reduce((sum, acc) => sum + (Number(acc.balance) || 0), 0);
    const daysInPeriod = Math.max(1, new Date(endDate).getDate());
    const avgDailyExpense = absExpense / daysInPeriod;
    const daysRemaining = Math.max(0, Math.ceil((new Date(endDate).getTime() - now.getTime()) / (1000 * 3600 * 24)));
    const forecastBalance = totalBalanceNow - (avgDailyExpense * daysRemaining);

    const forecastDateEl = document.getElementById('forecastDate');
    const forecastBigEl = document.getElementById('forecastBig');
    
    if (forecastDateEl) forecastDateEl.textContent = endDate;
    if (forecastBigEl) {
      forecastBigEl.textContent = formatCurrency(forecastBalance);
      forecastBigEl.style.color = forecastBalance >= 0 ? 'var(--accent-2)' : 'var(--accent)';
    }
      updateFinancialSignals();
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
  function updateTxnList() {
    const txnList = document.getElementById('txnList');
    txnList.innerHTML = '';
    
    const filterText = document.getElementById('filter').value.toLowerCase();
    const endDate = state.currentPeriod === 'month' ? getEndOfMonth(state.currentDate) : getEndOfWeek(state.currentDate);
    const startDate = state.currentPeriod === 'month' ? getStartOfMonth(state.currentDate) : getStartOfWeek(state.currentDate);
  
    const filteredTxns = state.transactions
      .filter(txn => txn.date >= startDate && txn.date <= endDate)
      .filter(txn => !filterText || txn.note.toLowerCase().includes(filterText) || state.categories.find(c => c.id === txn.catId)?.name.toLowerCase().includes(filterText))
      .sort((a, b) => new Date(b.date) - new Date(a.date));
  
    if (filteredTxns.length === 0) {
      txnList.innerHTML = '<div class="small" style="color:var(--muted)">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</div>';
      return;
    }
  
    filteredTxns.forEach(txn => {
      const cat = state.categories.find(c => c.id === txn.catId) || { name: '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', icon: '‚ùì' };
      const account = state.accounts.find(a => a.id === txn.accountId)?.name || '–°—á–µ—Ç —É–¥–∞–ª–µ–Ω';
      const amountStr = formatCurrency(Math.abs(txn.amount));
      const color = txn.amount >= 0 ? 'var(--accent-2)' : 'var(--accent)';
      
      const div = document.createElement('div');
      div.className = 'card clickable';
      div.style.padding = '8px 12px';
      div.innerHTML = `
        <div style="display:flex; flex-direction:column; flex:1">
          <div style="font-weight:bold; font-size:14px;">${cat.icon} ${txn.note || cat.name}</div>
          <div class="small" style="color:var(--muted);">${account} - ${new Date(txn.date).toLocaleDateString('ru-RU')}</div>
        </div>
        <div style="font-size:16px; font-weight:bold; color:${color}">${txn.amount >= 0 ? '+' : '‚àí'}${amountStr}</div>
      `;
      txnList.appendChild(div);
    });
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±—é–¥–∂–µ—Ç–æ–≤
  function updateBudgetList() {
    const budgetList = document.getElementById('budgetList');
    budgetList.innerHTML = '';
  
    if (state.budgets.length === 0) {
      budgetList.innerHTML = '<div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—é–¥–∂–µ—Ç–æ–≤.</div>';
      return;
    }
  
    const monthKey = getMonthKey(state.currentDate);
  
    state.budgets.forEach(budget => {
      // –†–∞—Å—á–µ—Ç –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–π —Å—É–º–º—ã –¥–ª—è –±—é–¥–∂–µ—Ç–∞
      const spent = state.transactions
        .filter(t => t.catId === budget.catId && getMonthKey(t.date) === monthKey && t.amount < 0)
        .reduce((sum, t) => sum + Math.abs(t.amount), 0);
  
      const remaining = budget.amount - spent;
      const percent = Math.min(100, (spent / budget.amount) * 100);
      const color = percent > 90 ? 'var(--accent)' : 'var(--accent-2)';
  
      const cat = state.categories.find(c => c.id === budget.catId) || { name: '–£–¥–∞–ª–µ–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è', icon: '‚ùå' };
  
      const div = document.createElement('div');
      div.className = 'card clickable';
      div.style.flexDirection = 'column';
      div.innerHTML = `
        <div style="font-weight:bold; color:${color}; font-size:16px; margin-bottom:4px;">${cat.icon} ${budget.name}</div>
        <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: <span style="font-weight:bold; color:var(--accent);">${formatCurrency(spent)}</span></div>
        <div class="goal-progress" style="height:6px; background:rgba(255,255,255,0.1);">
          <div class="goal-progress-bar" style="width:${percent}%; background:${color};"></div>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:4px;">
          <div>–û—Å—Ç–∞—Ç–æ–∫: <span style="font-weight:bold; color:${remaining >= 0 ? 'inherit' : 'var(--accent)'}">${formatCurrency(remaining)}</span> / ${formatCurrency(budget.amount)}</div>
          <div>${Math.round(percent)}%</div>
        </div>
      `;
      budgetList.appendChild(div);
    });
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ü–µ–ª–µ–π
  function updateGoalsList() {
    const goalsList = document.getElementById('goalsList');
    goalsList.innerHTML = '';
  
    if (state.goals.length === 0) {
      goalsList.innerHTML = '<div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π.</div>';
      return;
    }
  
    state.goals.forEach(goal => {
      const percent = Math.min(100, (goal.current / goal.target) * 100);
      const remaining = goal.target - goal.current;
      const color = 'var(--goal-color)';
  
      const div = document.createElement('div');
      div.className = 'goal-card clickable';
      div.setAttribute('data-id', goal.id);
      div.innerHTML = `
        <div class="goal-title">${goal.name}</div>
        <div class="goal-progress">
          <div class="goal-progress-bar" style="width:${percent}%; background:${color};"></div>
        </div>
        <div class="goal-meta">
          <span>${formatCurrency(goal.current)} / ${formatCurrency(goal.target)}</span>
          <span>${Math.round(percent)}% ${remaining > 0 ? `(${formatCurrency(remaining)} –æ—Å—Ç–∞–ª–æ—Å—å)` : ''}</span>
        </div>
      `;
      goalsList.appendChild(div);
    });
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—å—é "–î–æ–ª–≥–∏"
  function updateDebtsView() {
    const owedList = document.getElementById('owedDebtsList');
    const mineList = document.getElementById('mineDebtsList');
    const historyList = document.getElementById('debtHistoryList');
    let totalOwed = 0;
    let totalMine = 0;
  
    owedList.innerHTML = '';
    mineList.innerHTML = '';
    historyList.innerHTML = '';
  
    const activeDebts = state.debts.filter(d => d.amount !== 0);
    const owedDebts = activeDebts.filter(d => d.type === 'owed');
    const mineDebts = activeDebts.filter(d => d.type === 'mine');
    
    totalOwed = owedDebts.reduce((sum, d) => sum + d.amount, 0);
    totalMine = mineDebts.reduce((sum, d) => sum + d.amount, 0);
  
    document.getElementById('totalOwed').textContent = formatCurrency(totalOwed);
    document.getElementById('totalMine').textContent = formatCurrency(totalMine);
  
    if (owedDebts.length === 0) owedList.innerHTML = '<div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –¥–æ–ª–∂–Ω—ã.</div>';
    owedDebts.forEach(d => owedList.appendChild(createDebtCard(d)));
  
    if (mineDebts.length === 0) mineList.innerHTML = '<div class="small" style="color:var(--muted)">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –¥–æ–ª–∂–Ω—ã.</div>';
    mineDebts.forEach(d => mineList.appendChild(createDebtCard(d)));
  
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ–ª–≥–æ–≤ (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
    const debtTxns = state.transactions.filter(t => t.debtId);
    if (debtTxns.length === 0) {
      historyList.innerHTML = '<div class="small" style="color:var(--muted)">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –¥–æ–ª–≥–∞–º–∏, –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å.</div>';
    } else {
      debtTxns.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
        const debt = state.debts.find(d => d.id === t.debtId);
        if (!debt) return;
        const isReceived = debt.type === 'owed' && t.amount > 0;
        const isRepaid = debt.type === 'mine' && t.amount < 0;
        const action = isReceived ? '–ü–æ–ª—É—á–µ–Ω–æ' : isRepaid ? '–ü–æ–≥–∞—à–µ–Ω–æ' : '–î–µ–π—Å—Ç–≤–∏–µ —Å –¥–æ–ª–≥–æ–º';
        const amountStr = formatCurrency(Math.abs(t.amount));
        const colorClass = isReceived ? 'received' : isRepaid ? 'repaid' : '';
  
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <span class="h-date">${new Date(t.date).toLocaleDateString('ru-RU')}</span>
          <span class="h-name">${debt.name} (${action})</span>
          <span class="h-amount ${colorClass}">${isReceived ? '+' : '‚àí'} ${amountStr}</span>
        `;
        historyList.appendChild(div);
      });
    }
  }
  
  // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–æ–ª–≥–∞
  function createDebtCard(debt) {
    const div = document.createElement('div');
    div.className = 'debt-card';
    div.setAttribute('data-id', debt.id);
    div.addEventListener('click', () => openDebtActionModal(debt.id));
    
    const typeClass = debt.type === 'owed' ? 'owed' : 'mine';
    
    div.innerHTML = `
      <div class="debt-info">
        <div class="debt-name">${debt.name}</div>
        <div class="debt-meta">–° ${new Date(debt.date).toLocaleDateString('ru-RU')}</div>
      </div>
      <div class="debt-amount ${typeClass}">${formatCurrency(Math.abs(debt.amount))}</div>
      <button class="debt-actions">...</button>
    `;
    return div;
  }
  
  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ–π—Å—Ç–≤–∏–π —Å –¥–æ–ª–≥–æ–º
  function openDebtActionModal(debtId) {
    state.activeDebt = state.debts.find(d => d.id === debtId);
    if (!state.activeDebt) return;
  
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ —Å—á–µ—Ç–æ–≤
    const select = document.getElementById('debtActionAccount');
    select.innerHTML = state.accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
  
    document.getElementById('debtActionAmount').value = Math.abs(state.activeDebt.amount);
    document.getElementById('owedActions').style.display = state.activeDebt.type === 'owed' ? 'flex' : 'none';
    document.getElementById('mineActions').style.display = state.activeDebt.type === 'mine' ? 'flex' : 'none';
  
    toggleModal('debtModal', true);
  }
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è/–æ—Ç–º–µ–Ω—ã –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
  function closeAllModals() {
    toggleModal('rulesModal', false);
    toggleModal('settingsModal', false);
    toggleModal('debtModal', false);
    toggleModal('newDebtModal', false);
    toggleModal('goalsModal', false);
  }
  
  /* ==============================================
    –õ–û–ì–ò–ö–ê –î–ê–ù–ù–´–•
    ============================================== */
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  async function saveState() {
    await db.save(state);
  }
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  async function loadState() {
    const loaded = await db.load();
    if (loaded) {
      // –°–ª–∏—è–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
      state = { ...defaultState, ...loaded };
    } else {
      state = defaultState;
    }
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
    changeTab(state.activeTab);
  }
  
  // –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  function addTransaction(amount, note, catId, accountId, date = today(), debtId = null, ruleId = null) {
    amount = Number(amount);
    if (isNaN(amount) || amount === 0) return false;
  
    // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Å—á–µ—Ç–∞
    const account = state.accounts.find(a => a.id === accountId);
    if (account) {
      account.balance += amount;
    }
  
    // 2. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    const newTxn = {
      id: uid(),
      date: date,
      amount: amount,
      note: note,
      catId: catId,
      accountId: accountId,
      debtId: debtId,
      ruleId: ruleId
    };
    state.transactions.push(newTxn);
  
    // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ —Ü–µ–ª–∏, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –≤—Å–µ –¥–æ—Ö–æ–¥—ã –∏ —Ä–∞—Å—Ö–æ–¥—ã - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞)
    // –ë–æ–ª–µ–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ü–µ–ª–µ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–¥–µ—Å—å
  
    saveState();
    updateAccountsView();
    return true;
  }
  
  // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –¥–∞—Ç—É
  function calculateBalance(dateStr) {
    const initialBalance = state.accounts.reduce((sum, acc) => sum + acc.initial, 0);
    
    const txnsUpToDate = state.transactions.filter(txn => txn.date <= dateStr);
    const txnsSum = txnsUpToDate.reduce((sum, txn) => sum + txn.amount, 0);
  
    return initialBalance + txnsSum;
  }
  
  // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª (–∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π)
  function applyRules() {
    const now = new Date();
    state.rules.forEach(rule => {
      let nextDate = new Date(rule.nextDate + 'T00:00:00');
      
      while (nextDate <= now) {
        // –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        const amount = rule.type === 'expense' ? -Math.abs(Number(rule.amount)) : Math.abs(Number(rule.amount));
        addTransaction(
          amount,
          rule.name,
          rule.catId,
          state.accounts[0]?.id, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π —Å—á–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          nextDate.toISOString().slice(0, 10),
          null,
          rule.id
        );
  
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ nextDate
        if (rule.frequency === 'monthly') nextDate.setMonth(nextDate.getMonth() + 1);
        else if (rule.frequency === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
        else if (rule.frequency === 'yearly') nextDate.setFullYear(nextDate.getFullYear() + 1);
        
        rule.nextDate = nextDate.toISOString().slice(0, 10);
      }
    });
    saveState();
  }
  
  /* ==============================================
    –õ–û–ì–ò–ö–ê –ì–†–ê–§–ò–ö–û–í (CHART.JS)
    ============================================== */
  
  let miniChart, doughnutChart, lineChart;
  
  function updateMiniChart() {
    const canvas = document.getElementById('miniCanvas');
    if (!canvas) return;
  
    const dataPoints = [];
    const todayDate = new Date(state.currentDate);
    for (let i = 29; i >= 0; i--) {
      const date = new Date(todayDate);
      date.setDate(todayDate.getDate() - i);
      const dateStr = date.toISOString().slice(0, 10);
      dataPoints.push({
        date: dateStr,
        balance: calculateBalance(dateStr)
      });
    }
  
    if (miniChart) miniChart.destroy();
  
    miniChart = new Chart(canvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: dataPoints.map(p => p.date.slice(5)),
        datasets: [{
          label: '–ë–∞–ª–∞–Ω—Å',
          data: dataPoints.map(p => p.balance),
          borderColor: 'var(--accent-2)',
          tension: 0.4,
          pointRadius: 0,
          borderWidth: 2,
          fill: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: true } },
        scales: {
          x: { display: false, grid: { display: false } },
          y: { display: false, grid: { display: false } }
        }
      }
    });
  }
  
  function updateExpensesView() {
  const monthKey = getMonthKey(state.currentDate);

  const monthTxns = state.transactions.filter(
    t => getMonthKey(t.date) === monthKey
  );

  const categoryExpenses = monthTxns.reduce((acc, txn) => {
    const cat = state.categories.find(c => c.id === txn.catId);
    if (!cat) return acc;

    acc[cat.name] = acc[cat.name] || {
      amount: 0,
      count: 0,
      catId: cat.id,
      type: cat.type
    };

    acc[cat.name].amount += txn.amount;
    acc[cat.name].count++;

    return acc;
  }, {});

  const totalExpense = Object.values(categoryExpenses)
    .reduce((sum, c) => sum + Math.abs(c.amount), 0);

  // 1. Doughnut
  const doughnutData = Object.keys(categoryExpenses).map(name => ({
    label: name,
    amount: Math.abs(categoryExpenses[name].amount)
  }));
  
    if (doughnutChart) doughnutChart.destroy();
    const doughnutCanvas = document.getElementById('expenseDoughnutChart');
    if (doughnutCanvas && doughnutData.length > 0) {
      doughnutChart = new Chart(doughnutCanvas.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: doughnutData.map(d => d.label),
          datasets: [{
            data: doughnutData.map(d => d.amount),
            backgroundColor: doughnutData.map(d => getColor(d.label)),
            hoverOffset: 4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right', labels: { color: 'var(--text)' } },
            tooltip: { callbacks: { label: (context) => `${context.label}: ${formatCurrency(context.parsed)}` } }
          }
        }
      });
    }
  
    // 2. –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ (Line Chart)
    const lineData = getMonthlyExpenseData(6);
    if (lineChart) lineChart.destroy();
    const lineCanvas = document.getElementById('expenseLineChart');
    if (lineCanvas) {
      lineChart = new Chart(lineCanvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: lineData.map(d => d.month),
          datasets: [{
            label: '–†–∞—Å—Ö–æ–¥—ã',
            data: lineData.map(d => d.expense),
            borderColor: 'var(--accent)',
            tension: 0.3,
            backgroundColor: 'rgba(214, 40, 40, 0.2)',
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}` } }
          },
          scales: {
            x: { grid: { color: 'var(--glass)' }, ticks: { color: 'var(--muted)' } },
            y: { grid: { color: 'var(--glass)' }, ticks: { color: 'var(--muted)' } }
          }
        }
      });
    }
  
    // 3. –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const tableBody = document.getElementById('categoryTableBody');
    tableBody.innerHTML = '';
  
    const sortedCategories = Object.keys(categoryExpenses).sort((a, b) => categoryExpenses[b].amount - categoryExpenses[a].amount);
  
    if (sortedCategories.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" class="small" style="color:var(--muted); text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å—Ö–æ–¥–∞—Ö –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü.</td></tr>';
    } else {
      sortedCategories.forEach(name => {
        const data = categoryExpenses[name];
        const percent = totalExpense > 0 ? ((data.amount / totalExpense) * 100).toFixed(1) : 0;
        const row = tableBody.insertRow();
        row.innerHTML = `
          <td><span class="category-name">${state.categories.find(c => c.id === data.catId)?.icon} ${name}</span></td>
          <td>${data.count}</td>
          <td style="color:${data.amount < 0 ? 'var(--accent)' : 'var(--accent-2)'}">
  ${formatCurrency(data.amount)}
</td>

          <td>${percent}%</td>
        `;
      });
    }
  }
  
  function getMonthlyExpenseData(monthsCount) {
    const data = [];
    const currentDate = new Date(state.currentDate);
  
    for (let i = monthsCount - 1; i >= 0; i--) {
      const monthDate = new Date(currentDate);
      monthDate.setMonth(currentDate.getMonth() - i);
      const monthKey = getMonthKey(monthDate.toISOString());
      const monthName = monthDate.toLocaleString('ru-RU', { month: 'short' });
  
      const expense = state.transactions
        .filter(t => getMonthKey(t.date) === monthKey && t.amount < 0)
        .reduce((sum, t) => sum + Math.abs(t.amount), 0);
  
      data.push({ month: monthName, expense: expense });
    }
    return data;
  }
  
  /* ==============================================
    –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô (EVENT LISTENERS)
    ============================================== */
  
  document.addEventListener('DOMContentLoaded', () => {
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadState().then(() => {
      applyRules();
      changeTab(state.activeTab || 'accounts');
    });

    // -------------------- –¢–ê–ë–´ --------------------
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', (e) => changeTab(e.currentTarget.dataset.tab));
    });

    // -------------------- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê: –û–ë–©–ï–ï --------------------
    const overlayEl = document.getElementById('modalOverlay');
    if (overlayEl) {
      overlayEl.addEventListener('click', closeAllModals);
    }

    // -------------------- –ë–´–°–¢–†–´–ô –í–í–û–î --------------------
    const qAddBtn = document.getElementById('qAdd');
    if (qAddBtn) {
      qAddBtn.addEventListener('click', () => {
        const qAmountEl = document.getElementById('qAmount');
        const qNoteEl = document.getElementById('qNote');
        const qCatEl = document.getElementById('qCat');
        const qAccountEl = document.getElementById('qAccount');
        
        const amount = Number(qAmountEl?.value || 0);
        const note = qNoteEl?.value || '';
        const catId = qCatEl?.value;
        const accountId = qAccountEl?.value;
        
        if (!amount || !catId || !accountId) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ —Å—á–µ—Ç.');
        
        const cat = state.categories.find(c => c.id === catId);
        const finalAmount = cat?.type === 'expense' ? -Math.abs(amount) : Math.abs(amount);
        
        if (addTransaction(finalAmount, note, catId, accountId)) {
          if (qAmountEl) qAmountEl.value = '';
          if (qNoteEl) qNoteEl.value = '';
          updateAccountsView();
        }
      });
    }

    // -------------------- FAB –ö–ù–û–ü–ö–ê --------------------
    const openAddBtn = document.getElementById('openAdd');
    if (openAddBtn) {
      openAddBtn.addEventListener('click', () => {
        changeTab('accounts');
        const qAmountEl = document.getElementById('qAmount');
        if (qAmountEl) qAmountEl.focus();
      });
    }

    // -------------------- –§–ò–õ–¨–¢–† –¢–†–ê–ù–ó–ê–ö–¶–ò–ô --------------------
    const filterEl = document.getElementById('filter');
    if (filterEl) {
      filterEl.addEventListener('input', updateTxnList);
    }

    // -------------------- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ü–ï–†–ò–û–î–ê --------------------
    const summaryToggleEl = document.getElementById('summaryPeriodToggle');
    if (summaryToggleEl) {
      summaryToggleEl.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
          summaryToggleEl.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
          e.target.classList.add('active');
          state.currentPeriod = e.target.dataset.period;
          updateAccountsView();
          updateExpensesView();
          saveState();
        }
      });
    }

    // -------------------- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê: –î–û–õ–ì–ò --------------------
    const closeDebtModalEl = document.getElementById('closeDebtModal');
    if (closeDebtModalEl) {
      closeDebtModalEl.addEventListener('click', () => toggleModal('debtModal', false));
    }

    const closeNewDebtModalEl = document.getElementById('closeNewDebtModal');
    if (closeNewDebtModalEl) {
      closeNewDebtModalEl.addEventListener('click', () => toggleModal('newDebtModal', false));
    }

    const newOwedDebtBtnEl = document.getElementById('newOwedDebtBtn');
    if (newOwedDebtBtnEl) {
      newOwedDebtBtnEl.addEventListener('click', () => {
        const titleEl = document.getElementById('newDebtTitle');
        const saveBtnEl = document.getElementById('saveNewDebtBtn');
        if (titleEl) titleEl.textContent = '–ù–æ–≤—ã–π –î–æ–ª–≥ (–ú–Ω–µ –¥–æ–ª–∂–Ω—ã)';
        if (saveBtnEl) saveBtnEl.setAttribute('data-type', 'owed');
        toggleModal('newDebtModal', true);
      });
    }

    const newMineDebtBtnEl = document.getElementById('newMineDebtBtn');
    if (newMineDebtBtnEl) {
      newMineDebtBtnEl.addEventListener('click', () => {
        const titleEl = document.getElementById('newDebtTitle');
        const saveBtnEl = document.getElementById('saveNewDebtBtn');
        if (titleEl) titleEl.textContent = '–ù–æ–≤—ã–π –î–æ–ª–≥ (–Ø –¥–æ–ª–∂–µ–Ω)';
        if (saveBtnEl) saveBtnEl.setAttribute('data-type', 'mine');
        toggleModal('newDebtModal', true);
      });
    }

    const saveNewDebtBtnEl = document.getElementById('saveNewDebtBtn');
    if (saveNewDebtBtnEl) {
      saveNewDebtBtnEl.addEventListener('click', (e) => {
        const type = e.target.getAttribute('data-type');
        const amountEl = document.getElementById('newDebtAmount');
        const nameEl = document.getElementById('newDebtName');
        
        const amount = Number(amountEl?.value || 0);
        const name = nameEl?.value || '';

        if (!amount || !name) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –∏–º—è/–æ–ø–∏—Å–∞–Ω–∏–µ.');

        const newDebt = {
          id: uid(),
          name: name,
          amount: amount,
          type: type,
          date: today()
        };
        state.debts.push(newDebt);
        saveState();
        updateDebtsView();
        toggleModal('newDebtModal', false);
        if (amountEl) amountEl.value = '';
        if (nameEl) nameEl.value = '';
      });
    }

    // –î–µ–π—Å—Ç–≤–∏—è —Å –¥–æ–ª–≥–∞–º–∏
    function handleDebtAction(actionType) {
      if (!state.activeDebt) return;
      
      const amountEl = document.getElementById('debtActionAmount');
      const accountEl = document.getElementById('debtActionAccount');
      const nameEl = document.getElementById('debtActionName');
      
      const amount = Number(amountEl?.value || 0);
      const accountId = accountEl?.value;
      const note = nameEl?.value || '';
      
      if (!amount || !accountId) return alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç.');

      let txnAmount = 0;
      let catName = '';

      if (actionType === 'receive') {
        txnAmount = Math.min(amount, state.activeDebt.amount);
        state.activeDebt.amount -= txnAmount;
        catName = '–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞ (–í–∞–º)';
      } else if (actionType === 'repay') {
        txnAmount = -Math.min(amount, state.activeDebt.amount);
        state.activeDebt.amount -= txnAmount;
        catName = '–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞ (–í–∞—à)';
      } else if (actionType === 'forgive' || actionType === 'askForgive') {
        state.activeDebt.amount = 0;
        saveState();
        updateDebtsView();
        toggleModal('debtModal', false);
        return;
      } else {
        return;
      }

      let debtCat = state.categories.find(c => c.name === '–î–æ–ª–≥–∏');
      if (!debtCat) {
        debtCat = { id: uid(), name: '–î–æ–ª–≥–∏', type: 'expense', icon: '‚öñÔ∏è' };
        state.categories.push(debtCat);
      }

      addTransaction(txnAmount, note || catName, debtCat.id, accountId, today(), state.activeDebt.id);
      saveState();
      updateDebtsView();
      updateAccountsView();
      toggleModal('debtModal', false);
    }

    const debtReceiveBtnEl = document.getElementById('debtReceiveBtn');
    if (debtReceiveBtnEl) {
      debtReceiveBtnEl.addEventListener('click', () => handleDebtAction('receive'));
    }

    const debtForgiveBtnEl = document.getElementById('debtForgiveBtn');
    if (debtForgiveBtnEl) {
      debtForgiveBtnEl.addEventListener('click', () => handleDebtAction('forgive'));
    }

    const debtRepayBtnEl = document.getElementById('debtRepayBtn');
    if (debtRepayBtnEl) {
      debtRepayBtnEl.addEventListener('click', () => handleDebtAction('repay'));
    }

    const debtAskForgiveBtnEl = document.getElementById('debtAskForgiveBtn');
    if (debtAskForgiveBtnEl) {
      debtAskForgiveBtnEl.addEventListener('click', () => handleDebtAction('askForgive'));
    }

    // -------------------- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê: –ù–ê–°–¢–†–û–ô–ö–ò --------------------
    const settingsBtnEl = document.getElementById('settingsBtn');
    if (settingsBtnEl) {
      settingsBtnEl.addEventListener('click', () => {
        const catListEl = document.getElementById('categoryList');
        const accListEl = document.getElementById('accountSettingsList');
        const budListEl = document.getElementById('budgetSettingsList');

        if (catListEl) {
          catListEl.innerHTML = state.categories.map(c => `
            <div class="card" data-id="${c.id}">
              <div>${c.icon} ${c.name}</div>
              <button style="color:var(--accent)">‚úï</button>
            </div>
          `).join('');
        }

        if (accListEl) {
          accListEl.innerHTML = state.accounts.map(a => `
            <div class="card" data-id="${a.id}">
              <div>${a.name} (${formatCurrency(a.balance)})</div>
              <button style="color:var(--accent)">‚úï</button>
            </div>
          `).join('');
        }

        if (budListEl) {
          budListEl.innerHTML = state.budgets.map(b => `
            <div class="card" data-id="${b.id}">
              <div>${b.name} (${formatCurrency(b.amount)})</div>
              <button style="color:var(--accent)">‚úï</button>
            </div>
          `).join('');
        }

        toggleModal('settingsModal', true);
      });
    }

    const closeSettingsEl = document.getElementById('closeSettings');
    if (closeSettingsEl) {
      closeSettingsEl.addEventListener('click', closeAllModals);
    }

    const newCatBtnEl = document.getElementById('newCatBtn');
    if (newCatBtnEl) {
      newCatBtnEl.addEventListener('click', () => {
        const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:');
        if (name) {
          const type = confirm('–≠—Ç–æ –î–æ—Ö–æ–¥ (–û–ö) –∏–ª–∏ –†–∞—Å—Ö–æ–¥ (–û—Ç–º–µ–Ω–∞)?') ? 'income' : 'expense';
          state.categories.push({ id: uid(), name, type, icon: 'üí°' });
          saveState();
          updateQuickInput();
          if (settingsBtnEl) settingsBtnEl.click();
        }
      });
    }

    const settingsModalEl = document.getElementById('settingsModal');
    if (settingsModalEl) {
      settingsModalEl.addEventListener('click', (e) => {
        if (e.target.textContent === '‚úï') {
          const card = e.target.closest('.card');
          if (!card) return;
          const id = card.dataset.id;

          if (card.closest('#categoryList')) {
            state.categories = state.categories.filter(c => c.id !== id);
          } else if (card.closest('#accountSettingsList')) {
            state.accounts = state.accounts.filter(a => a.id !== id);
          } else if (card.closest('#budgetSettingsList')) {
            state.budgets = state.budgets.filter(b => b.id !== id);
          }

          saveState();
          updateQuickInput();
          updateAccountsView();
          if (settingsBtnEl) settingsBtnEl.click();
        }
      });
    }

    const newAccBtnEl = document.getElementById('newAccBtn');
    if (newAccBtnEl) {
      newAccBtnEl.addEventListener('click', () => {
        const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞:');
        if (name) {
          const balance = Number(prompt('–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (0):') || 0);
          state.accounts.push({ id: uid(), name, balance, initial: balance });
          saveState();
          updateQuickInput();
          updateAccountsView();
          if (settingsBtnEl) settingsBtnEl.click();
        }
      });
    }

    const newBudgetBtnEl = document.getElementById('newBudgetBtn');
    if (newBudgetBtnEl) {
      newBudgetBtnEl.addEventListener('click', () => {
        const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞:');
        if (name) {
          const amount = Number(prompt('–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞:'));
          const catId = prompt(`ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ${state.categories[0]?.id}):`);
          if (amount && catId) {
            state.budgets.push({ id: uid(), name, amount, catId });
            saveState();
            updateAccountsView();
            if (settingsBtnEl) settingsBtnEl.click();
          }
        }
      });
    }

    // -------------------- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê: –ü–†–ê–í–ò–õ–ê --------------------
    const rulesBtnEl = document.getElementById('rulesBtn');
    if (rulesBtnEl) {
      rulesBtnEl.addEventListener('click', () => {
        updateRulesList();
        toggleModal('rulesModal', true);
      });
    }

    const closeRulesEl = document.getElementById('closeRules');
    if (closeRulesEl) {
      closeRulesEl.addEventListener('click', closeAllModals);
    }

    const newRuleBtnEl = document.getElementById('newRuleBtn');
    if (newRuleBtnEl) {
      newRuleBtnEl.addEventListener('click', () => {
        const formEl = document.getElementById('newRuleForm');
        const nextDateEl = document.getElementById('ruleNextDate');
        const nameEl = document.getElementById('ruleName');
        const amountEl = document.getElementById('ruleAmount');

        if (formEl) formEl.style.display = 'block';
        newRuleBtnEl.style.display = 'none';
        if (nextDateEl) nextDateEl.value = today();
        if (nameEl) nameEl.value = '';
        if (amountEl) amountEl.value = '';
      });
    }

    const cancelRuleBtnEl = document.getElementById('cancelRuleBtn');
    if (cancelRuleBtnEl) {
      cancelRuleBtnEl.addEventListener('click', () => {
        const formEl = document.getElementById('newRuleForm');
        if (formEl) formEl.style.display = 'none';
        if (newRuleBtnEl) newRuleBtnEl.style.display = 'block';
      });
    }

    const saveRuleBtnEl = document.getElementById('saveRuleBtn');
    if (saveRuleBtnEl) {
      saveRuleBtnEl.addEventListener('click', () => {
        const nameEl = document.getElementById('ruleName');
        const amountEl = document.getElementById('ruleAmount');
        const typeEl = document.getElementById('ruleType');
        const nextDateEl = document.getElementById('ruleNextDate');
        const frequencyEl = document.getElementById('ruleFrequency');

        const name = nameEl?.value || '';
        const amount = Number(amountEl?.value || 0);
        const type = typeEl?.value || 'expense';
        const nextDate = nextDateEl?.value || '';
        const frequency = frequencyEl?.value || 'monthly';

        if (!name || !amount || !nextDate) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');

        state.rules.push({
          id: uid(),
          name,
          amount,
          type,
          nextDate,
          frequency,
          catId: state.categories.find(c => c.type === type)?.id || state.categories[0]?.id
        });
        saveState();
        applyRules();
        updateRulesList();
        if (cancelRuleBtnEl) cancelRuleBtnEl.click();
      });
    }

    const rulesListEl = document.getElementById('rulesList');
    if (rulesListEl) {
      rulesListEl.addEventListener('click', (e) => {
        if (e.target.textContent === '‚úï') {
          const card = e.target.closest('.card');
          if (card) {
            state.rules = state.rules.filter(r => r.id !== card.dataset.id);
            saveState();
            updateRulesList();
          }
        }
      });
    }

    function updateRulesList() {
      const rulesList = document.getElementById('rulesList');
      if (!rulesList) return;
      
      rulesList.innerHTML = state.rules.map(r => `
        <div class="card" data-id="${r.id}" style="padding:10px; border-color:var(--accent-2);">
          <div>
            <div style="font-weight:bold; color:${r.type === 'expense' ? 'var(--accent)' : 'var(--accent-2)'}">${r.name}</div>
            <div class="small" style="color:var(--muted)">${r.frequency === 'monthly' ? '–ï–∂–µ–º–µ—Å—è—á–Ω–æ' : r.frequency === 'weekly' ? '–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ' : '–ï–∂–µ–≥–æ–¥–Ω–æ'} | –°–ª–µ–¥. ${new Date(r.nextDate + 'T00:00:00').toLocaleDateString('ru-RU')}</div>
          </div>
          <div style="font-size:18px; font-weight:bold; color:${r.type === 'expense' ? 'var(--accent)' : 'var(--accent-2)'}">${r.type === 'expense' ? '‚àí' : '+'}${formatCurrency(r.amount)}</div>
          <button style="color:var(--accent); margin-left:8px;">‚úï</button>
        </div>
      `).join('') || '<div class="small" style="color:var(--muted); text-align:center;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª.</div>';
    }

    // -------------------- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê: –¶–ï–õ–ò --------------------
    const openGoalsBtnEl = document.getElementById('openGoalsBtn');
    if (openGoalsBtnEl) {
      openGoalsBtnEl.addEventListener('click', () => {
        updateGoalsSettingsList();
        toggleModal('goalsModal', true);
      });
    }

    const closeGoalsModalEl = document.getElementById('closeGoalsModal');
    if (closeGoalsModalEl) {
      closeGoalsModalEl.addEventListener('click', closeAllModals);
    }

    const newGoalBtnEl = document.getElementById('newGoalBtn');
    if (newGoalBtnEl) {
      newGoalBtnEl.addEventListener('click', () => {
        const formEl = document.getElementById('newGoalForm');
        if (formEl) formEl.style.display = 'block';
        newGoalBtnEl.style.display = 'none';
      });
    }

    const cancelGoalBtnEl = document.getElementById('cancelGoalBtn');
    if (cancelGoalBtnEl) {
      cancelGoalBtnEl.addEventListener('click', () => {
        const formEl = document.getElementById('newGoalForm');
        if (formEl) formEl.style.display = 'none';
        if (newGoalBtnEl) newGoalBtnEl.style.display = 'block';
      });
    }

    const saveGoalBtnEl = document.getElementById('saveGoalBtn');
    if (saveGoalBtnEl) {
      saveGoalBtnEl.addEventListener('click', () => {
        const nameEl = document.getElementById('goalName');
        const targetEl = document.getElementById('goalTarget');
        const currentEl = document.getElementById('goalCurrent');

        const name = nameEl?.value || '';
        const target = Number(targetEl?.value || 0);
        const current = Number(currentEl?.value || 0);

        if (!name || !target) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–ª–µ–≤—É—é —Å—É–º–º—É!');

        state.goals.push({ id: uid(), name, target, current, date: today() });
        saveState();
        updateGoalsSettingsList();
        updateGoalsList();
        if (cancelGoalBtnEl) cancelGoalBtnEl.click();
      });
    }

    const goalsSettingsListEl = document.getElementById('goalsSettingsList');
    if (goalsSettingsListEl) {
      goalsSettingsListEl.addEventListener('click', (e) => {
        if (e.target.textContent === '‚úï') {
          const card = e.target.closest('.card');
          if (card) {
            state.goals = state.goals.filter(g => g.id !== card.dataset.id);
            saveState();
            updateGoalsSettingsList();
            updateGoalsList();
          }
        }
      });
    }

    function updateGoalsSettingsList() {
      const goalsSettingsList = document.getElementById('goalsSettingsList');
      if (!goalsSettingsList) return;
      
      goalsSettingsList.innerHTML = state.goals.map(g => {
        const percent = Math.min(100, (g.current / g.target) * 100);
        return `
          <div class="card" data-id="${g.id}" style="padding:10px; border-color:var(--goal-color); flex-direction:column; align-items:flex-start;">
            <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
              <div style="font-weight:bold; color:var(--goal-color)">${g.name}</div>
              <button style="color:var(--accent); margin-left:8px;">‚úï</button>
            </div>
            <div class="small" style="color:var(--muted)">${formatCurrency(g.current)} / ${formatCurrency(g.target)} (${Math.round(percent)}%)</div>
          </div>
        `;
      }).join('') || '<div class="small" style="color:var(--muted); text-align:center;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π.</div>';
    }

    // –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    updateAccountsView();
  });
/* ==============================================
   –§–ò–ù–ê–ù–°–û–í–´–ï –°–ò–ì–ù–ê–õ–´ ‚Äî –õ–û–ì–ò–ö–ê
   ============================================== */
function updateFinancialSignals() {
  const todayDate = state.currentDate;

  const startDate =
    state.currentPeriod === 'month'
      ? getStartOfMonth(todayDate)
      : getStartOfWeek(todayDate);

  const endDate =
    state.currentPeriod === 'month'
      ? getEndOfMonth(todayDate)
      : getEndOfWeek(todayDate);

  const periodTxns = state.transactions.filter(
    t => t.date >= startDate && t.date <= endDate && t.amount < 0
  );

  /* === –°–∞–º–∞—è –∑–∞—Ç—Ä–∞—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è === */
  const byCategory = {};
  periodTxns.forEach(t => {
    byCategory[t.catId] = (byCategory[t.catId] || 0) + Math.abs(t.amount);

  });

  let topCatId = null;
  let topCatAmount = 0;

  for (const id in byCategory) {
    if (byCategory[id] > topCatAmount) {
      topCatAmount = byCategory[id];
      topCatId = id;
    }
  }

  const topCategoryEl = document.getElementById('topCategory');
  if (topCategoryEl) {
    if (!topCatId) {
      topCategoryEl.textContent = '‚Äî';
    } else {
      const cat = state.categories.find(c => c.id === topCatId);
      topCategoryEl.textContent =
        (cat?.icon || '') + ' ' + (cat?.name || '‚Äî');
    }
  }

  /* === –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å === */
  const daysPassed =
    state.currentPeriod === 'month'
      ? new Date(todayDate).getDate()
      : Math.max(1, (new Date(todayDate) - new Date(startDate)) / 86400000 + 1);

  const totalExpense = periodTxns.reduce((s, t) => s + Math.abs(t.amount), 0);
  const avgDaily = daysPassed > 0 ? totalExpense / daysPassed : 0;

  const avgDailyEl = document.getElementById('avgDailyExpense');
  if (avgDailyEl) avgDailyEl.textContent = formatCurrency(avgDaily);

  /* === –ù–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Ö–≤–∞—Ç–∏—Ç –¥–µ–Ω–µ–≥ === */
  const balance = state.accounts.reduce((s, a) => s + a.balance, 0);
  const daysLeft =
    avgDaily > 0 ? Math.floor(balance / avgDaily) : '‚àû';

  const daysLeftEl = document.getElementById('daysLeft');
  if (daysLeftEl) {
    daysLeftEl.textContent =
      daysLeft === '‚àû' ? '‚àû –¥–Ω–µ–π' : `${daysLeft} –¥–Ω–µ–π`;
  }

  /* === –ë–ª–∏–∂–∞–π—à–µ–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ === */
  const upcomingRule = state.rules
    .filter(r => r.type === 'expense' && r.nextDate >= todayDate)
    .sort((a, b) => a.nextDate.localeCompare(b.nextDate))[0];

  const nextRuleEl = document.getElementById('nextRule');
  if (nextRuleEl) {
    nextRuleEl.textContent = upcomingRule
      ? `${upcomingRule.name} ‚àí${formatCurrency(upcomingRule.amount)}`
      : '‚Äî';
  }

  /* === –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å === */
  const statusEl = document.getElementById('financeStatus');
  if (!statusEl) return;

  statusEl.className = 'signals-status';

  if (balance < 0 || daysLeft !== '‚àû' && daysLeft < 7) {
    statusEl.textContent = '–†–∏—Å–∫';
    statusEl.classList.add('bad');
  } else if (daysLeft !== '‚àû' && daysLeft < 14) {
    statusEl.textContent = '–í–Ω–∏–º–∞–Ω–∏–µ';
    statusEl.classList.add('warn');
  } else {
    statusEl.textContent = '–ù–æ—Ä–º–∞';
    statusEl.classList.add('ok');
  }
}

})();
</script>

<!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<button id="openAdd" class="fab" aria-label="–î–æ–±–∞–≤–∏—Ç—å">+</button>
</body>
</html>
